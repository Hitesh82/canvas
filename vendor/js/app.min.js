function ToolManager(e){this.canvas=e,this.tools={},this.activeTool="select",window.addEventListener("keydown",e=>{this.tools[this.activeTool]?.onKeyDown?.(e)})}ToolManager.prototype.register=function(e,t){t.canvas=this.canvas,(t.manager=this).tools[e]=t},ToolManager.prototype.setActive=function(e){this.activeTool&&this.tools[this.activeTool]?.onDisable&&this.tools[this.activeTool].onDisable(),this.activeTool=e,this.tools[e]?.onEnable&&this.tools[e].onEnable(),console.log("ðŸ›  Active tool:",e)},ToolManager.prototype.dispatch=function(e,t){var a=this.tools[this.activeTool];a&&(e=a[e])&&e.call(a,t)};var rough=(()=>{function n(t,a,l){if(t&&t.length){let[o,r]=a,e=Math.PI/180*l,n=Math.cos(e),s=Math.sin(e);t.forEach(e=>{var[t,a]=e;e[0]=(t-o)*n-(a-r)*s+o,e[1]=(t-o)*s+(a-r)*n+r})}}function p(e){var t=e[0],e=e[1];return Math.sqrt(Math.pow(t[0]-e[0],2)+Math.pow(t[1]-e[1],2))}function D(e,t,a,o){var r=t[1]-e[1],t=e[0]-t[0],e=r*e[0]+t*e[1],n=o[1]-a[1],o=a[0]-o[0],a=n*a[0]+o*a[1],s=r*o-n*t;return s?[(o*e-t*a)/s,(r*a-n*e)/s]:null}function i(o,e,t){var r=o.length;if(r<3)return!1;var n=[Number.MAX_SAFE_INTEGER,t],s=[e,t];let l=0;for(let a=0;a<r;a++){let e=o[a],t=o[(a+1)%r];if(d(e,t,s,n)){if(0===h(e,s,t))return c(e,s,t);l++}}return l%2==1}function c(e,t,a){return t[0]<=Math.max(e[0],a[0])&&t[0]>=Math.min(e[0],a[0])&&t[1]<=Math.max(e[1],a[1])&&t[1]>=Math.min(e[1],a[1])}function h(e,t,a){e=(t[1]-e[1])*(a[0]-t[0])-(t[0]-e[0])*(a[1]-t[1]);return 0==e?0:0<e?1:2}function d(e,t,a,o){var r=h(e,t,a),n=h(e,t,o),s=h(a,o,e),l=h(a,o,t);return r!==n&&s!==l||0===r&&c(e,a,t)||0===n&&c(e,o,t)||0===s&&c(a,e,o)||0===l&&c(a,t,o)}function r(e,a){var o=[0,0],r=Math.round(a.hachureAngle+90),a=(r&&n(e,o,r),((e,a)=>{let o=[...e],s=(o[0].join(",")!==o[o.length-1].join(",")&&o.push([o[0][0],o[0][1]]),[]);if(o&&2<o.length){let t=a.hachureGap;t<0&&(t=4*a.strokeWidth),t=Math.max(t,.1);var l=[];for(let e=0;e<o.length-1;e++){let t=o[e],a=o[e+1];if(t[1]!==a[1]){let e=Math.min(t[1],a[1]);l.push({ymin:e,ymax:Math.max(t[1],a[1]),x:(e===t[1]?t:a)[0],islope:(a[0]-t[0])/(a[1]-t[1])})}}if(l.sort((e,t)=>e.ymin<t.ymin?-1:e.ymin>t.ymin?1:e.x<t.x?-1:e.x>t.x?1:e.ymax===t.ymax?0:(e.ymax-t.ymax)/Math.abs(e.ymax-t.ymax)),!l.length)return s;let r=[],n=l[0].ymin;for(;r.length||l.length;){if(l.length){let t=-1;for(let e=0;e<l.length&&!(l[e].ymin>n);e++)t=e;l.splice(0,t+1).forEach(e=>{r.push({s:n,edge:e})})}if((r=r.filter(e=>!(e.edge.ymax<=n))).sort((e,t)=>e.edge.x===t.edge.x?0:(e.edge.x-t.edge.x)/Math.abs(e.edge.x-t.edge.x)),1<r.length)for(let o=0;o<r.length;o+=2){let e=o+1;if(e>=r.length)break;let t=r[o].edge,a=r[e].edge;s.push([[Math.round(t.x),n],[Math.round(a.x),n]])}n+=t,r.forEach(e=>{e.edge.x=e.edge.x+t*e.edge.islope})}}return s})(e,a));if(r){n(e,o,-r);{e=o,o=-r;let t=[];a.forEach(e=>t.push(...e)),n(t,e,o)}}return a}class o{constructor(e){this.helper=e}fillPolygon(e,t){return this._fillPolygon(e,t)}_fillPolygon(t,e,a=!1){let o=r(t,e);if(a){let e=this.connectingLines(t,o);o=o.concat(e)}return{type:"fillSketch",ops:this.renderLines(o,e)}}renderLines(e,t){var a,o=[];for(a of e)o.push(...this.helper.doubleLineOps(a[0][0],a[0][1],a[1][0],a[1][1],t));return o}connectingLines(t,a){var o=[];if(1<a.length)for(let e=1;e<a.length;e++){var r=a[e-1];if(!(p(r)<3)){r=[a[e][0],r[1]];if(3<p(r)){let e=this.splitOnIntersections(t,r);o.push(...e)}}}return o}midPointInPolygon(e,t){return i(e,(t[0][0]+t[1][0])/2,(t[0][1]+t[1][1])/2)}splitOnIntersections(r,n){let o=Math.max(5,.1*p(n)),s=[];for(let e=0;e<r.length;e++){var t=r[e],l=r[(e+1)%r.length];if(d(t,l,...n)){let a=D(t,l,n[0],n[1]);if(a){let e=p([a,n[0]]),t=p([a,n[1]]);e>o&&t>o&&s.push({point:a,distance:e})}}}if(1<s.length){let e=s.sort((e,t)=>e.distance-t.distance).map(e=>e.point);if(i(r,...n[0])||e.shift(),i(r,...n[1])||e.pop(),e.length<=1)return this.midPointInPolygon(r,n)?[n]:[];let a=[n[0],...e,n[1]],o=[];for(let t=0;t<a.length-1;t+=2){let e=[a[t],a[t+1]];this.midPointInPolygon(r,e)&&o.push(e)}return o}return this.midPointInPolygon(r,n)?[n]:[]}}class B extends o{fillPolygon(e,t){return this._fillPolygon(e,t,!0)}}class F extends o{fillPolygon(e,t){var a=this._fillPolygon(e,t),t=Object.assign({},t,{hachureAngle:t.hachureAngle+90}),e=this._fillPolygon(e,t);return a.ops=a.ops.concat(e.ops),a}}class z{constructor(e){this.helper=e}fillPolygon(e,t){e=r(e,t=Object.assign({},t,{curveStepCount:4,hachureAngle:0,roughness:1}));return this.dotsOnLines(e,t)}dotsOnLines(e,i){var c=[];let h=i.hachureGap,d=(h<0&&(h=4*i.strokeWidth),h=Math.max(h,.1),i.fillWeight);d<0&&(d=i.strokeWidth/2);var o,u=h/4;for(o of e){let e=p(o),t=e/h,a=Math.ceil(t)-1,n=e-a*h,s=(o[0][0]+o[1][0])/2-h/4,l=Math.min(o[0][1],o[1][1]);for(let r=0;r<a;r++){let e=l+n+r*h,t=this.helper.randOffsetWithRange(s-u,s+u,i),a=this.helper.randOffsetWithRange(e-u,e+u,i),o=this.helper.ellipse(t,a,d,d,i);c.push(...o.ops)}}return{type:"fillSketch",ops:c}}}class N{constructor(e){this.helper=e}fillPolygon(e,t){e=r(e,t);return{type:"fillSketch",ops:this.dashedLine(e,t)}}dashedLine(e,i){let c=i.dashOffset<0?i.hachureGap<0?4*i.strokeWidth:i.hachureGap:i.dashOffset,h=i.dashGap<0?i.hachureGap<0?4*i.strokeWidth:i.hachureGap:i.dashGap,d=[];return e.forEach(e=>{let t=p(e),a=Math.floor(t/(c+h)),n=(t+h-a*(c+h))/2,s=e[0],o=e[1];s[0]>o[0]&&(s=e[1],o=e[0]);var l=Math.atan((o[1]-s[1])/(o[0]-s[0]));for(let r=0;r<a;r++){let e=r*(c+h),t=e+c,a=[s[0]+e*Math.cos(l)+n*Math.cos(l),s[1]+e*Math.sin(l)+n*Math.sin(l)],o=[s[0]+t*Math.cos(l)+n*Math.cos(l),s[1]+t*Math.sin(l)+n*Math.sin(l)];d.push(...this.helper.doubleLineOps(a[0],a[1],o[0],o[1],i))}}),d}}class H{constructor(e){this.helper=e}fillPolygon(e,t){var a=t.hachureGap<0?4*t.strokeWidth:t.hachureGap,o=t.zigzagOffset<0?a:t.zigzagOffset,e=r(e,t=Object.assign({},t,{hachureGap:a+o}));return{type:"fillSketch",ops:this.zigzagLines(e,o,t)}}zigzagLines(e,c,h){let d=[];return e.forEach(e=>{let t=p(e),a=Math.round(t/(2*c)),l=e[0],o=e[1];l[0]>o[0]&&(l=e[1],o=e[0]);var i=Math.atan((o[1]-l[1])/(o[0]-l[0]));for(let s=0;s<a;s++){let e=2*s*c,t=2*(s+1)*c,a=Math.sqrt(2*Math.pow(c,2)),o=[l[0]+e*Math.cos(i),l[1]+e*Math.sin(i)],r=[l[0]+t*Math.cos(i),l[1]+t*Math.sin(i)],n=[o[0]+a*Math.cos(i+Math.PI/4),o[1]+a*Math.sin(i+Math.PI/4)];d.push(...this.helper.doubleLineOps(o[0],o[1],n[0],n[1],h),...this.helper.doubleLineOps(n[0],n[1],r[0],r[1],h))}}),d}}let s={};class t{constructor(e){this.seed=e}next(){return this.seed?(2**31-1&(this.seed=Math.imul(48271,this.seed)))/2**31:Math.random()}}let u={A:7,a:7,C:6,c:6,H:1,h:1,L:2,l:2,M:2,m:2,Q:4,q:4,S:4,s:4,T:2,t:2,V:1,v:1,Z:0,z:0};function f(e,t){return e.type===t}function g(e){let t=[],o=(e=>{for(var t=new Array;""!==e;){if(!e.match(/^([ \t\r\n,]+)/))if(e.match(/^([aAcChHlLmMqQsStTvVzZ])/))t[t.length]={type:0,text:RegExp.$1};else{if(!e.match(/^(([-+]?[0-9]+(\.[0-9]*)?|[-+]?\.[0-9]+)([eE][-+]?[0-9]+)?)/))return[];t[t.length]={type:1,text:""+parseFloat(RegExp.$1)}}e=e.substr(RegExp.$1.length)}return t[t.length]={type:2,text:""},t})(e),r="BOD",n=0,s=o[n];for(;!f(s,2);){let a=0;var l=[];if("BOD"===r){if("M"!==s.text&&"m"!==s.text)return g("M0,0"+e);n++,a=u[s.text],r=s.text}else f(s,1)?a=u[r]:(n++,a=u[s.text],r=s.text);if(!(n+a<o.length))throw new Error("Path data ended short");for(let t=n;t<n+a;t++){let e=o[t];if(!f(e,1))throw new Error("Param not a number: "+r+","+e.text);l[l.length]=+e.text}if("number"!=typeof u[r])throw new Error("Bad segment: "+r);{let e={key:r,data:l};t.push(e),n+=a,s=o[n],"m"===(r="M"===r?"L":r)&&(r="l")}}return t}function v(e){let a=0,o=0,t=0,r=0;var n,s,l=[];for({key:n,data:s}of e)switch(n){case"M":l.push({key:"M",data:[...s]}),[a,o]=s,[t,r]=s;break;case"m":a+=s[0],o+=s[1],l.push({key:"M",data:[a,o]}),t=a,r=o;break;case"L":l.push({key:"L",data:[...s]}),[a,o]=s;break;case"l":a+=s[0],o+=s[1],l.push({key:"L",data:[a,o]});break;case"C":l.push({key:"C",data:[...s]}),a=s[4],o=s[5];break;case"c":{let e=s.map((e,t)=>t%2?e+o:e+a);l.push({key:"C",data:e}),a=e[4],o=e[5];break}case"Q":l.push({key:"Q",data:[...s]}),a=s[2],o=s[3];break;case"q":{let e=s.map((e,t)=>t%2?e+o:e+a);l.push({key:"Q",data:e}),a=e[2],o=e[3];break}case"A":l.push({key:"A",data:[...s]}),a=s[5],o=s[6];break;case"a":a+=s[5],o+=s[6],l.push({key:"A",data:[s[0],s[1],s[2],s[3],s[4],a,o]});break;case"H":l.push({key:"H",data:[...s]}),a=s[0];break;case"h":a+=s[0],l.push({key:"H",data:[a]});break;case"V":l.push({key:"V",data:[...s]}),o=s[0];break;case"v":o+=s[0],l.push({key:"V",data:[o]});break;case"S":l.push({key:"S",data:[...s]}),a=s[2],o=s[3];break;case"s":{let e=s.map((e,t)=>t%2?e+o:e+a);l.push({key:"S",data:e}),a=e[2],o=e[3];break}case"T":l.push({key:"T",data:[...s]}),a=s[0],o=s[1];break;case"t":a+=s[0],o+=s[1],l.push({key:"T",data:[a,o]});break;case"Z":case"z":l.push({key:"Z",data:[]}),a=t,o=r}return l}function y(e){let i=[],r="",c=0,h=0,t=0,a=0,d=0,u=0;for(var{key:o,data:p}of e){switch(o){case"M":i.push({key:"M",data:[...p]}),[c,h]=p,[t,a]=p;break;case"C":i.push({key:"C",data:[...p]}),c=p[4],h=p[5],d=p[2],u=p[3];break;case"L":i.push({key:"L",data:[...p]}),[c,h]=p;break;case"H":c=p[0],i.push({key:"L",data:[c,h]});break;case"V":h=p[0],i.push({key:"L",data:[c,h]});break;case"S":{let e=0,t=0;t="C"===r||"S"===r?(e=c+(c-d),h+(h-u)):(e=c,h),i.push({key:"C",data:[e,t,...p]}),d=p[0],u=p[1],c=p[2],h=p[3];break}case"T":{let[e,t]=p,a=0,o=0;o="Q"===r||"T"===r?(a=c+(c-d),h+(h-u)):(a=c,h);var n=c+2*(a-c)/3,s=h+2*(o-h)/3,l=e+2*(a-e)/3,f=t+2*(o-t)/3;i.push({key:"C",data:[n,s,l,f,e,t]}),d=a,u=o,c=e,h=t;break}case"Q":{let[e,t,a,o]=p,r=c+2*(e-c)/3,n=h+2*(t-h)/3,s=a+2*(e-a)/3,l=o+2*(t-o)/3;i.push({key:"C",data:[r,n,s,l,a,o]}),d=e,u=t,c=a,h=o;break}case"A":{let e=Math.abs(p[0]),t=Math.abs(p[1]),a=p[2],o=p[3],r=p[4],n=p[5],s=p[6];0===e||0===t?(i.push({key:"C",data:[c,h,n,s,n,s]}),c=n,h=s):c===n&&h===s||(function o(i,c,h,d,u,p,r,f,g,e){t=r;let v=Math.PI*t/180;var t;let n=[],y=0,m=0,k=0,b=0;if(e)[y,m,k,b]=e;else{[i,c]=T(i,c,-v),[h,d]=T(h,d,-v);let e=(i-h)/2,t=(c-d)/2,a=e*e/(u*u)+t*t/(p*p),o=(1<a&&(a=Math.sqrt(a),u*=a,p*=a),u*u),r=p*p,n=o*r-o*t*t-r*e*e,s=o*t*t+r*e*e,l=(f===g?-1:1)*Math.sqrt(Math.abs(n/s));k=l*u*t/p+(i+h)/2,b=l*-p*e/u+(c+d)/2,y=Math.asin(parseFloat(((c-b)/p).toFixed(9))),m=Math.asin(parseFloat(((d-b)/p).toFixed(9))),i<k&&(y=Math.PI-y),h<k&&(m=Math.PI-m),y<0&&(y=2*Math.PI+y),m<0&&(m=2*Math.PI+m),g&&y>m&&(y-=2*Math.PI),!g&&m>y&&(m-=2*Math.PI)}let a=m-y;if(Math.abs(a)>120*Math.PI/180){let e=m,t=h,a=d;m=g&&m>y?y+120*Math.PI/180*1:y+120*Math.PI/180*-1,n=o(h=k+u*Math.cos(m),d=b+p*Math.sin(m),t,a,u,p,r,0,g,[m,e,k,b])}a=m-y;let s=Math.cos(y),l=Math.sin(y),M=Math.cos(m),S=Math.sin(m),w=Math.tan(a/4),x=4/3*u*w,E=4/3*p*w,O=[i,c],A=[i+x*l,c-E*s],C=[h+x*S,d-E*M],L=[h,d];if(A[0]=2*O[0]-A[0],A[1]=2*O[1]-A[1],e)return[A,C,L].concat(n);{n=[A,C,L].concat(n);let r=[];for(let o=0;o<n.length;o+=3){let e=T(n[o][0],n[o][1],v),t=T(n[o+1][0],n[o+1][1],v),a=T(n[o+2][0],n[o+2][1],v);r.push([e[0],e[1],t[0],t[1],a[0],a[1]])}return r}}(c,h,n,s,e,t,a,o,r).forEach(function(e){i.push({key:"C",data:e})}),c=n,h=s);break}case"Z":i.push({key:"Z",data:[]}),c=t,h=a}r=o}return i}function T(e,t,a){return[e*Math.cos(a)-t*Math.sin(a),e*Math.sin(a)+t*Math.cos(a)]}let G={randOffset:function(e,t){return O(e,t)},randOffsetWithRange:function(e,t,a){return E(e,t,a)},ellipse:function(e,t,a,o,r){return b(e,t,r,k(a,o,r)).opset},doubleLineOps:function(e,t,a,o,r){return A(e,t,a,o,r,!0)}};function l(e,t,a,o,r){return{type:"path",ops:A(e,t,a,o,r)}}function m(t,e,a){var o=(t||[]).length;if(2<o){var r=[];for(let e=0;e<o-1;e++)r.push(...A(t[e][0],t[e][1],t[e+1][0],t[e+1][1],a));return e&&r.push(...A(t[o-1][0],t[o-1][1],t[0][0],t[0][1],a)),{type:"path",ops:r}}return 2===o?l(t[0][0],t[0][1],t[1][0],t[1][1],a):{type:"path",ops:[]}}function k(e,t,a){var o=Math.sqrt(2*Math.PI*Math.sqrt((Math.pow(e/2,2)+Math.pow(t/2,2))/2)),o=Math.max(a.curveStepCount,a.curveStepCount/Math.sqrt(200)*o),o=2*Math.PI/o,e=Math.abs(e/2),t=Math.abs(t/2),r=1-a.curveFitting;return{increment:o,rx:e+=O(e*r,a),ry:t+=O(t*r,a)}}function b(a,o,r,n){let[e,t]=$(n.increment,a,o,n.rx,n.ry,1,n.increment*E(.1,E(.4,1,r),r),r),s=L(e,null,r);if(!r.disableMultiStroke){let[e]=$(n.increment,a,o,n.rx,n.ry,1.5,0,r),t=L(e,null,r);s=s.concat(t)}return{estimatedPoints:t,opset:{type:"path",ops:s}}}function M(e,t,a,o,r,n,s,l,i){var c=e,a=Math.abs(a/2),o=Math.abs(o/2);a+=O(.01*a,i),o+=O(.01*o,i);let h=r,d=n;for(;h<0;)h+=2*Math.PI,d+=2*Math.PI;d-h>2*Math.PI&&(h=0,d=2*Math.PI);e=2*Math.PI/i.curveStepCount,r=Math.min(e/2,(d-h)/2),n=U(r,c,t,a,o,h,d,1,i);if(!i.disableMultiStroke){let e=U(r,c,t,a,o,h,d,1.5,i);n.push(...e)}return s&&(l?n.push(...A(c,t,c+a*Math.cos(h),t+o*Math.sin(h),i),...A(c,t,c+a*Math.cos(d),t+o*Math.sin(d),i)):n.push({op:"lineTo",data:[c,t]},{op:"lineTo",data:[c+a*Math.cos(h),t+o*Math.sin(h)]})),{type:"path",ops:n}}function S(t,a){var o=[];if(t.length){var r=a.maxRandomnessOffset||0,n=t.length;if(2<n){o.push({op:"move",data:[t[0][0]+O(r,a),t[0][1]+O(r,a)]});for(let e=1;e<n;e++)o.push({op:"lineTo",data:[t[e][0]+O(r,a),t[e][1]+O(r,a)]})}}return{type:"fillPath",ops:o}}function w(e,t){return((e,t)=>{let a=e.fillStyle||"hachure";if(!s[a])switch(a){case"zigzag":s[a]||(s[a]=new B(t));break;case"cross-hatch":s[a]||(s[a]=new F(t));break;case"dots":s[a]||(s[a]=new z(t));break;case"dashed":s[a]||(s[a]=new N(t));break;case"zigzag-line":s[a]||(s[a]=new H(t));break;default:a="hachure",s[a]||(s[a]=new o(t))}return s[a]})(t,G).fillPolygon(e,t)}function x(e){return e.randomizer||(e.randomizer=new t(e.seed||0)),e.randomizer.next()}function E(e,t,a,o=1){return a.roughness*o*(x(a)*(t-e)+e)}function O(e,t,a=1){return E(-e,e,t,a)}function A(e,t,a,o,r,n=!1){var n=n?r.disableMultiStrokeFill:r.disableMultiStroke,s=C(e,t,a,o,r,!0,!1);return n?s:(n=C(e,t,a,o,r,!0,!0),s.concat(n))}function C(e,t,a,o,r,n,s){var l=Math.pow(e-a,2)+Math.pow(t-o,2),i=Math.sqrt(l);let c,h=(c=i<200?1:500<i?.4:-.0016668*i+1.233334,r.maxRandomnessOffset||0),d=(h=h*h*100>l?i/10:h)/2,u=.2+.2*x(r);var l=r.bowing*r.maxRandomnessOffset*(e-a)/200,i=O(r.bowing*r.maxRandomnessOffset*(o-t)/200,r,c),l=O(l,r,c),p=[],f=()=>O(d,r,c),g=()=>O(h,r,c),v=r.preserveVertices;return n&&p.push(s?{op:"move",data:[e+(v?0:f()),t+(v?0:f())]}:{op:"move",data:[e+(v?0:O(h,r,c)),t+(v?0:O(h,r,c))]}),p.push(s?{op:"bcurveTo",data:[i+e+(a-e)*u+f(),l+t+(o-t)*u+f(),i+e+2*(a-e)*u+f(),l+t+2*(o-t)*u+f(),a+(v?0:f()),o+(v?0:f())]}:{op:"bcurveTo",data:[i+e+(a-e)*u+g(),l+t+(o-t)*u+g(),i+e+2*(a-e)*u+g(),l+t+2*(o-t)*u+g(),a+(v?0:g()),o+(v?0:g())]}),p}function J(t,a,o){var r=[];r.push([t[0][0]+O(a,o),t[0][1]+O(a,o)]),r.push([t[0][0]+O(a,o),t[0][1]+O(a,o)]);for(let e=1;e<t.length;e++)r.push([t[e][0]+O(a,o),t[e][1]+O(a,o)]),e===t.length-1&&r.push([t[e][0]+O(a,o),t[e][1]+O(a,o)]);return L(r,null,o)}function L(a,t,o){var e=a.length,r=[];if(3<e){var n=[],s=1-o.curveTightness;r.push({op:"move",data:[a[1][0],a[1][1]]});for(let t=1;t+2<e;t++){let e=a[t];n[0]=[e[0],e[1]],n[1]=[e[0]+(s*a[t+1][0]-s*a[t-1][0])/6,e[1]+(s*a[t+1][1]-s*a[t-1][1])/6],n[2]=[a[t+1][0]+(s*a[t][0]-s*a[t+2][0])/6,a[t+1][1]+(s*a[t][1]-s*a[t+2][1])/6],n[3]=[a[t+1][0],a[t+1][1]],r.push({op:"bcurveTo",data:[n[1][0],n[1][1],n[2][0],n[2][1],n[3][0],n[3][1]]})}if(t&&2===t.length){let e=o.maxRandomnessOffset;r.push({op:"lineTo",data:[t[0]+O(e,o),t[1]+O(e,o)]})}}else 3===e?(r.push({op:"move",data:[a[1][0],a[1][1]]}),r.push({op:"bcurveTo",data:[a[1][0],a[1][1],a[2][0],a[2][1],a[2][0],a[2][1]]})):2===e&&r.push(...A(a[0][0],a[0][1],a[1][0],a[1][1],o));return r}function $(e,a,o,r,n,s,t,l){var i=[],c=[],h=O(.5,l)-Math.PI/2;c.push([O(s,l)+a+.9*r*Math.cos(h-e),O(s,l)+o+.9*n*Math.sin(h-e)]);for(let t=h;t<2*Math.PI+h-.01;t+=e){let e=[O(s,l)+a+r*Math.cos(t),O(s,l)+o+n*Math.sin(t)];i.push(e),c.push(e)}return c.push([O(s,l)+a+r*Math.cos(h+2*Math.PI+.5*t),O(s,l)+o+n*Math.sin(h+2*Math.PI+.5*t)]),c.push([O(s,l)+a+.98*r*Math.cos(h+t),O(s,l)+o+.98*n*Math.sin(h+t)]),c.push([O(s,l)+a+.9*r*Math.cos(h+.5*t),O(s,l)+o+.9*n*Math.sin(h+.5*t)]),[c,i]}function U(t,a,o,r,n,s,l,i,c){var s=s+O(.1,c),h=[];h.push([O(i,c)+a+.9*r*Math.cos(s-t),O(i,c)+o+.9*n*Math.sin(s-t)]);for(let e=s;e<=l;e+=t)h.push([O(i,c)+a+r*Math.cos(e),O(i,c)+o+n*Math.sin(e)]);return h.push([a+r*Math.cos(l),o+n*Math.sin(l)]),h.push([a+r*Math.cos(l),o+n*Math.sin(l)]),L(h,null,c)}function P(e){return[...e]}function I(e,t){return Math.pow(e[0]-t[0],2)+Math.pow(e[1]-t[1],2)}function j(e,t,a){return[e[0]+(t[0]-e[0])*a,e[1]+(t[1]-e[1])*a]}function R(h,d,u,e){var t,a,p=e||[];if((()=>{var e=h[d+0],t=h[d+1],a=h[d+2],o=h[d+3];let r=3*t[0]-2*e[0]-o[0],n=(r*=r,3*t[1]-2*e[1]-o[1]);return n*=n,t=3*a[0]-2*o[0]-e[0],t*=t,a=3*a[1]-2*o[1]-e[1],a*=a,r<t&&(r=t),n<a&&(n=a),r+n})()<u){let e=h[d+0];(!p.length||(t=p[p.length-1],a=e,1<Math.sqrt(I(t,a))))&&p.push(e),p.push(h[d+3])}else{let e=h[d+0],t=h[d+1],a=h[d+2],o=h[d+3],r=j(e,t,.5),n=j(t,a,.5),s=j(a,o,.5),l=j(r,n,.5),i=j(n,s,.5),c=j(l,i,.5);R([e,r,l,c],0,u,p),R([c,i,s,o],0,u,p)}}function q(a,e,o,t,r){var n,s,l,i,r=r||[],c=a[e],h=a[o-1];let d=0,u=1;for(let t=e+1;t<o-1;++t){n=a[t],i=void 0;let e=0===(i=I(s=c,l=h))?I(n,s):(i=((n[0]-s[0])*(l[0]-s[0])+(n[1]-s[1])*(l[1]-s[1]))/i,I(n,j(s,l,i=Math.max(0,Math.min(1,i)))));e>d&&(d=e,u=t)}return Math.sqrt(d)>t?(q(a,e,u+1,t,r),q(a,u,o,t,r)):(r.length||r.push(c),r.push(h)),r}function V(t,a=.15,e){var o=[],r=(t.length-1)/3;for(let e=0;e<r;e++)R(t,3*e,a,o);return e&&0<e?q(o,0,o.length,e):o}let _="none";class a{constructor(e){this.defaultOptions={maxRandomnessOffset:2,roughness:1,bowing:1,stroke:"#000",strokeWidth:1,curveTightness:0,curveFitting:.95,curveStepCount:9,fillStyle:"hachure",fillWeight:-1,hachureAngle:-41,hachureGap:-1,dashOffset:-1,dashGap:-1,zigzagOffset:-1,seed:0,combineNestedSvgPaths:!1,disableMultiStroke:!1,disableMultiStrokeFill:!1,preserveVertices:!1},this.config=e||{},this.config.options&&(this.defaultOptions=this._o(this.config.options))}static newSeed(){return Math.floor(Math.random()*2**31)}_o(e){return e?Object.assign({},this.defaultOptions,e):this.defaultOptions}_d(e,t,a){return{shape:e,sets:t||[],options:a||this.defaultOptions}}line(e,t,a,o,r){r=this._o(r);return this._d("line",[l(e,t,a,o,r)],r)}rectangle(t,a,o,r,e){var n=this._o(e),s=[],e=m([[t,a],[t+o,a],[t+o,a+r],[t,a+r]],!0,n);if(n.fill){let e=[[t,a],[t+o,a],[t+o,a+r],[t,a+r]];"solid"===n.fillStyle?s.push(S(e,n)):s.push(w(e,n))}return n.stroke!==_&&s.push(e),this._d("rectangle",s,n)}ellipse(t,a,e,o,r){var r=this._o(r),n=[],o=k(e,o,r),e=b(t,a,r,o);if(r.fill)if("solid"===r.fillStyle){let e=b(t,a,r,o).opset;e.type="fillPath",n.push(e)}else n.push(w(e.estimatedPoints,r));return r.stroke!==_&&n.push(e.opset),this._d("ellipse",n,r)}circle(e,t,a,o){e=this.ellipse(e,t,a,a,o);return e.shape="circle",e}linearPath(e,t){t=this._o(t);return this._d("linearPath",[m(e,!1,t)],t)}arc(u,p,f,t,a,o,e=!1,r){var r=this._o(r),n=[],s=M(u,p,f,t,a,o,e,!0,r);if(e&&r.fill)if("solid"===r.fillStyle){let e=M(u,p,f,t,a,o,!0,!1,r);e.type="fillPath",n.push(e)}else n.push(((e,t,a,o)=>{var r=u,n=p,s=Math.abs(f/2),l=Math.abs(e/2);s+=O(.01*s,o),l+=O(.01*l,o);let i=t,c=a;for(;i<0;)i+=2*Math.PI,c+=2*Math.PI;c-i>2*Math.PI&&(i=0,c=2*Math.PI);var h=(c-i)/o.curveStepCount,d=[];for(let e=i;e<=c;e+=h)d.push([r+s*Math.cos(e),n+l*Math.sin(e)]);return d.push([r+s*Math.cos(c),n+l*Math.sin(c)]),d.push([r,n]),w(d,o)})(t,a,o,r));return r.stroke!==_&&n.push(s),this._d("arc",n,r)}curve(t,e){var a=this._o(e),o=[],e=((e,t)=>{let a=J(e,1+.2*t.roughness,t);return t.disableMultiStroke||(e=J(e,1.5*(1+.22*t.roughness),(e=t,(t=Object.assign({},e)).randomizer=void 0,e.seed&&(t.seed=e.seed+1),t)),a=a.concat(e)),{type:"path",ops:a}})(t,a);if(a.fill&&a.fill!==_&&3<=t.length){let e=V(((t,e=0)=>{let a=t.length;if(a<3)throw new Error("A curve must have at least three points.");var o=[];if(3===a)o.push(P(t[0]),P(t[1]),P(t[2]),P(t[2]));else{let a=[];a.push(t[0],t[0]);for(let e=1;e<t.length;e++)a.push(t[e]),e===t.length-1&&a.push(t[e]);var r=[],n=1-e;o.push(P(a[0]));for(let t=1;t+2<a.length;t++){let e=a[t];r[0]=[e[0],e[1]],r[1]=[e[0]+(n*a[t+1][0]-n*a[t-1][0])/6,e[1]+(n*a[t+1][1]-n*a[t-1][1])/6],r[2]=[a[t+1][0]+(n*a[t][0]-n*a[t+2][0])/6,a[t+1][1]+(n*a[t][1]-n*a[t+2][1])/6],r[3]=[a[t+1][0],a[t+1][1]],o.push(r[1],r[2],r[3])}}return o})(t),10,(1+a.roughness)/2);"solid"===a.fillStyle?o.push(S(e,a)):o.push(w(e,a))}return a.stroke!==_&&o.push(e),this._d("curve",o,a)}polygon(e,t){var t=this._o(t),a=[],o=m(e,!0,t);return t.fill&&("solid"===t.fillStyle?a.push(S(e,t)):a.push(w(e,t))),t.stroke!==_&&a.push(o),this._d("polygon",a,t)}path(e,t){let a=this._o(t),o=[];if(e){e=(e||"").replace(/\n/g," ").replace(/(-\s)/g,"-").replace("/(ss)/g"," ");var t=a.fill&&"transparent"!==a.fill&&a.fill!==_,r=a.stroke!==_,n=!!(a.simplification&&a.simplification<1),s=((e,t,a)=>{let o=y(v(g(e))),r=[],n=[],s=[0,0],l=[],i=()=>{4<=l.length&&n.push(...V(l,t)),l=[]},c=()=>{i(),n.length&&(r.push(n),n=[])};for(let{key:e,data:t}of o)switch(e){case"M":c(),s=[t[0],t[1]],n.push(s);break;case"L":i(),n.push([t[0],t[1]]);break;case"C":if(!l.length){let e=n.length?n[n.length-1]:s;l.push([e[0],e[1]])}l.push([t[0],t[1]]),l.push([t[2],t[3]]),l.push([t[4],t[5]]);break;case"Z":i(),n.push([s[0],s[1]])}if(c(),!a)return r;var h=[];for(let t of r){let e=q(t,0,t.length,a);e.length&&h.push(e)}return h})(e,1,n?4-4*a.simplification:(1+a.roughness)/2);if(t)if(a.combineNestedSvgPaths){let t=[];s.forEach(e=>t.push(...e)),"solid"===a.fillStyle?o.push(S(t,a)):o.push(w(t,a))}else s.forEach(e=>{"solid"===a.fillStyle?o.push(S(e,a)):o.push(w(e,a))});r&&(n?s.forEach(e=>{o.push(m(e,!1,a))}):o.push(((e,l)=>{let t=y(v(g(e))),i=[],o=[0,0],c=[0,0];for(let{key:e,data:s}of t)switch(e){case"M":{let t=+(l.maxRandomnessOffset||0),a=l.preserveVertices;i.push({op:"move",data:s.map(e=>e+(a?0:O(t,l)))}),c=[s[0],s[1]],o=[s[0],s[1]];break}case"L":i.push(...A(c[0],c[1],s[0],s[1],l)),c=[s[0],s[1]];break;case"C":{let[e,t,a,o,r,n]=s;i.push(...((t,a,o,r,n,s,l,i)=>{var c,h=[],d=[i.maxRandomnessOffset||1,(i.maxRandomnessOffset||1)+.3],u=i.disableMultiStroke?1:2,p=i.preserveVertices;for(let e=0;e<u;e++)0===e?h.push({op:"move",data:[l[0],l[1]]}):h.push({op:"move",data:[l[0]+(p?0:O(d[0],i)),l[1]+(p?0:O(d[0],i))]}),c=p?[n,s]:[n+O(d[e],i),s+O(d[e],i)],h.push({op:"bcurveTo",data:[t+O(d[e],i),a+O(d[e],i),o+O(d[e],i),r+O(d[e],i),c[0],c[1]]});return h})(e,t,a,o,r,n,c,l)),c=[r,n];break}case"Z":i.push(...A(c[0],c[1],o[0],o[1],l)),c=[o[0],o[1]]}return{type:"path",ops:i}})(e,a)))}return this._d("path",o,a)}opsToPath(e,t){let a="";for(var o of e.ops){let e="number"==typeof t&&0<=t?o.data.map(e=>+e.toFixed(t)):o.data;switch(o.op){case"move":a+=`M${e[0]} ${e[1]} `;break;case"bcurveTo":a+=`C${e[0]} ${e[1]}, ${e[2]} ${e[3]}, ${e[4]} ${e[5]} `;break;case"lineTo":a+=`L${e[0]} ${e[1]} `}}return a.trim()}toPaths(e){var a=e.sets||[],o=e.options||this.defaultOptions,r=[];for(let t of a){let e=null;switch(t.type){case"path":e={d:this.opsToPath(t),stroke:o.stroke,strokeWidth:o.strokeWidth,fill:_};break;case"fillPath":e={d:this.opsToPath(t),stroke:_,strokeWidth:0,fill:o.fill||_};break;case"fillSketch":e=this.fillSketch(t,o)}e&&r.push(e)}return r}fillSketch(e,t){let a=t.fillWeight;return a<0&&(a=t.strokeWidth/2),{d:this.opsToPath(e),stroke:t.fill||_,strokeWidth:a,fill:_}}}class X{constructor(e,t){this.canvas=e,this.ctx=this.canvas.getContext("2d"),this.gen=new a(t)}draw(t){let e=t.sets||[],a=t.options||this.getDefaultOptions(),o=this.ctx;for(var r of e)switch(r.type){case"path":o.save(),o.strokeStyle="none"===a.stroke?"transparent":a.stroke,o.lineWidth=a.strokeWidth,a.strokeLineDash&&o.setLineDash(a.strokeLineDash),a.strokeLineDashOffset&&(o.lineDashOffset=a.strokeLineDashOffset),this._drawToContext(o,r),o.restore();break;case"fillPath":o.save(),o.fillStyle=a.fill||"";let e="curve"===t.shape||"polygon"===t.shape?"evenodd":"nonzero";this._drawToContext(o,r,e),o.restore();break;case"fillSketch":this.fillSketch(o,r,a)}}fillSketch(e,t,a){let o=a.fillWeight;o<0&&(o=a.strokeWidth/2),e.save(),a.fillLineDash&&e.setLineDash(a.fillLineDash),a.fillLineDashOffset&&(e.lineDashOffset=a.fillLineDashOffset),e.strokeStyle=a.fill||"",e.lineWidth=o,this._drawToContext(e,t),e.restore()}_drawToContext(a,e,t="nonzero"){a.beginPath();for(let t of e.ops){let e=t.data;switch(t.op){case"move":a.moveTo(e[0],e[1]);break;case"bcurveTo":a.bezierCurveTo(e[0],e[1],e[2],e[3],e[4],e[5]);break;case"lineTo":a.lineTo(e[0],e[1])}}"fillPath"===e.type?a.fill(t):a.stroke()}get generator(){return this.gen}getDefaultOptions(){return this.gen.defaultOptions}line(e,t,a,o,r){e=this.gen.line(e,t,a,o,r);return this.draw(e),e}rectangle(e,t,a,o,r){e=this.gen.rectangle(e,t,a,o,r);return this.draw(e),e}ellipse(e,t,a,o,r){e=this.gen.ellipse(e,t,a,o,r);return this.draw(e),e}circle(e,t,a,o){e=this.gen.circle(e,t,a,o);return this.draw(e),e}linearPath(e,t){e=this.gen.linearPath(e,t);return this.draw(e),e}polygon(e,t){e=this.gen.polygon(e,t);return this.draw(e),e}arc(e,t,a,o,r,n,s=!1,l){e=this.gen.arc(e,t,a,o,r,n,s,l);return this.draw(e),e}curve(e,t){e=this.gen.curve(e,t);return this.draw(e),e}path(e,t){e=this.gen.path(e,t);return this.draw(e),e}}let W="http://www.w3.org/2000/svg";class Z{constructor(e,t){this.svg=e,this.gen=new a(t)}draw(t){var a,e=t.sets||[],o=t.options||this.getDefaultOptions(),r=this.svg.ownerDocument||window.document,n=r.createElementNS(W,"g"),s=t.options.fixedDecimalPlaceDigits;for(a of e){let e=null;switch(a.type){case"path":(e=r.createElementNS(W,"path")).setAttribute("d",this.opsToPath(a,s)),e.setAttribute("stroke",o.stroke),e.setAttribute("stroke-width",o.strokeWidth+""),e.setAttribute("fill","none"),o.strokeLineDash&&e.setAttribute("stroke-dasharray",o.strokeLineDash.join(" ").trim()),o.strokeLineDashOffset&&e.setAttribute("stroke-dashoffset",""+o.strokeLineDashOffset);break;case"fillPath":(e=r.createElementNS(W,"path")).setAttribute("d",this.opsToPath(a,s)),e.setAttribute("stroke","none"),e.setAttribute("stroke-width","0"),e.setAttribute("fill",o.fill||""),"curve"!==t.shape&&"polygon"!==t.shape||e.setAttribute("fill-rule","evenodd");break;case"fillSketch":e=this.fillSketch(r,a,o)}e&&n.appendChild(e)}return n}fillSketch(e,t,a){let o=a.fillWeight;o<0&&(o=a.strokeWidth/2);e=e.createElementNS(W,"path");return e.setAttribute("d",this.opsToPath(t,a.fixedDecimalPlaceDigits)),e.setAttribute("stroke",a.fill||""),e.setAttribute("stroke-width",o+""),e.setAttribute("fill","none"),a.fillLineDash&&e.setAttribute("stroke-dasharray",a.fillLineDash.join(" ").trim()),a.fillLineDashOffset&&e.setAttribute("stroke-dashoffset",""+a.fillLineDashOffset),e}get generator(){return this.gen}getDefaultOptions(){return this.gen.defaultOptions}opsToPath(e,t){return this.gen.opsToPath(e,t)}line(e,t,a,o,r){e=this.gen.line(e,t,a,o,r);return this.draw(e)}rectangle(e,t,a,o,r){e=this.gen.rectangle(e,t,a,o,r);return this.draw(e)}ellipse(e,t,a,o,r){e=this.gen.ellipse(e,t,a,o,r);return this.draw(e)}circle(e,t,a,o){e=this.gen.circle(e,t,a,o);return this.draw(e)}linearPath(e,t){e=this.gen.linearPath(e,t);return this.draw(e)}polygon(e,t){e=this.gen.polygon(e,t);return this.draw(e)}arc(e,t,a,o,r,n,s=!1,l){e=this.gen.arc(e,t,a,o,r,n,s,l);return this.draw(e)}curve(e,t){e=this.gen.curve(e,t);return this.draw(e)}path(e,t){e=this.gen.path(e,t);return this.draw(e)}}return{canvas:(e,t)=>new X(e,t),svg:(e,t)=>new Z(e,t),generator:e=>new a(e),newSeed:()=>a.newSeed()}})();function createEllipseTool(r,e,t){let n=!1,s,l,i=null;return{onEnable(){r.selection=!1},onDisable(){r.selection=!0,n=!1,i=null},onMouseDown(e){n=!0;var e=r.getPointer(e.e),e=(s=e.x,l=e.y,document.querySelector(".stroke-color-click.active")),e=e?e.dataset.strokeColor:"#000",t=document.querySelector(".background-click.active"),t=t?window.getComputedStyle(t).backgroundColor:"rgba(0,0,0,0.2)";(i=new fabric.Ellipse({left:s,top:l,rx:1,ry:1,fill:t,stroke:e,strokeWidth:1,originX:"center",originY:"center"})).name="ellipse",r.add(i)},onMouseMove(e){var t,a,o;n&&i&&(e=r.getPointer(e.e),t=(s+e.x)/2,a=(l+e.y)/2,o=Math.max(Math.abs(e.x-s)/2,1),e=Math.max(Math.abs(e.y-l)/2,1),i.set({left:t,top:a,rx:o,ry:e}),i.setCoords(),r.requestRenderAll())},onMouseUp(){n=!1,i=null,t.saveToLocal(),e.setActive(null)}}}function createSquareTool(a,e,t){let o=!1,r,n,s=null;return{onEnable(){a.selection=!1},onDisable(){a.selection=!0,o=!1,s=null},onMouseDown(e){o=!0;var e=a.getPointer(e.e),e=(r=e.x,n=e.y,document.querySelector(".stroke-color-click.active")),e=e?e.dataset.strokeColor:"#000",t=document.querySelector(".background-click.active"),t=t?window.getComputedStyle(t).backgroundColor:"rgba(0,0,0,0.2)";(s=new fabric.Rect({left:r,top:n,width:1,height:1,fill:t,stroke:e,strokeWidth:1,originX:"left",originY:"top",roughness:3})).name="square",a.add(s)},onMouseMove(e){o&&s&&(e=a.getPointer(e.e),e=Math.min(Math.abs(e.x-r),Math.abs(e.y-n)),s.set({width:e,height:e}),s.setCoords(),a.requestRenderAll())},onMouseUp(){o&&(o=!1,t.saveToLocal(),s=null,e.setActive(null))}}}function createDiamondTool(r,e,t){let n=!1,s,l,i=null;return{onEnable(){r.selection=!1},onDisable(){r.selection=!0,n=!1,i=null},onMouseDown(e){n=!0;var e=r.getPointer(e.e),e=(s=e.x,l=e.y,document.querySelector(".stroke-color-click.active")),e=e?e.dataset.strokeColor:"#000",t=document.querySelector(".background-click.active"),t=t?window.getComputedStyle(t).backgroundColor:"rgba(0,0,0,0.2)";(i=new fabric.Rect({left:s,top:l,width:1,height:1,fill:t,stroke:e,strokeWidth:1,originX:"center",originY:"center",angle:45})).name="diamond",r.add(i)},onMouseMove(e){var t,a,o;n&&i&&(e=r.getPointer(e.e),t=(s+e.x)/2,a=(l+e.y)/2,o=Math.max(Math.abs(e.x-s),1),e=Math.max(Math.abs(e.y-l),1),o=Math.min(o,e),i.set({left:t,top:a,width:o,height:o}),i.setCoords(),r.requestRenderAll())},onMouseUp(){n=!1,i=null,t.saveToLocal(),e.setActive(null)}}}function getBBoxFromPoints(e){let a=1/0,o=1/0,r=-1/0,n=-1/0;return e.forEach(([e,t])=>{e<a&&(a=e),t<o&&(o=t),e>r&&(r=e),t>n&&(n=t)}),{left:a,top:o,width:r-a,height:n-o}}function isPathClosed(a){if(a.length<5)return!1;var e=a[0],t=a[a.length-1];if(4<Math.hypot(t[0]-e[0],t[1]-e[1]))return!1;let o=0;for(let t=2;t<a.length;t++){var[r,n]=a[t-2],[s,l]=a[t-1],[i,c]=a[t],n=Math.atan2(l-n,s-r);let e=Math.atan2(c-l,i-s)-n;e>Math.PI&&(e-=2*Math.PI),e<-Math.PI&&(e+=2*Math.PI),o+=Math.abs(e)}return o>1.5*Math.PI}function pointsToPath(e,t){e=e.map((e,t)=>0===t?["M",e[0],e[1]]:["L",e[0],e[1]]);return t&&e.push(["Z"]),e}function checkFreehandClosed(e){e=e.selected?.[0]||e.target;e&&"freeHand"===e.name&&(isPathClosed(e.path.filter(e=>"M"===e[0]||"L"===e[0]).map(e=>[e[1],e[2]]))||e.set({fill:null,patternSrc:null,backgroundColor:null}),e.canvas.requestRenderAll())}function createFreeHandTool(r){let a=!1,n=null,s=[];function l(){a=!1,n&&r.remove(n),n=null,s=[]}return{onEnable(){r.selection=!1,r.defaultCursor="crosshair"},onDisable(){l(),r.selection=!0,r.defaultCursor="default"},onMouseDown(e){var t;e.target||(a=!0,s=[],e=r.getPointer(e.e),s.push([e.x,e.y]),t=JSON.parse(localStorage.getItem("currentOption"))||{},n=new fabric.Path([["M",e.x,e.y]],{stroke:t.strokeColor||"#000",strokeWidth:t.strokeWidth||2,fill:null,selectable:!1,evented:!1,objectCaching:!1,strokeLineCap:"round",strokeLineJoin:"round"}),r.add(n))},onMouseMove(e){a&&n&&(e=r.getPointer(e.e),s.push([e.x,e.y]),n.set({path:s.map((e,t)=>0===t?["M",e[0],e[1]]:["L",e[0],e[1]])}),r.requestRenderAll())},onMouseUp(){var e,t,a,o;n&&(r.remove(n),s.length<3||(o=getBBoxFromPoints(s),e=isPathClosed(s),t=(a=JSON.parse(localStorage.getItem("currentOption"))||{}).strokeColor||"#000",a=a.strokeWidth||2,(o=new fabric.Path(pointsToPath(s,e),{left:o.left,top:o.top,stroke:t,strokeWidth:a,fill:null,originX:"left",originY:"top",selectable:!0,evented:!0,objClosed:e})).name="freeHand",r.add(o),r.setActiveObject(o),r.requestRenderAll()),l())}}}function loadFontSafe(e){return["Times New Roman","Arial","Verdana","Georgia","Courier New","Tahoma"].includes(e=e||"Roboto")?Promise.resolve():document.fonts.load("20px "+e)}function preloadRoboto(){return document.fonts.load("20px Roboto")}((e,a)=>{var t,o;fabric.Object.prototype.toObject=(t=fabric.Object.prototype.toObject,function(){this.fill;return fabric.util.object.extend(t.call(this),{id:this.id||null,name:this.name||null,edgeStyle:this.edgeStyle||"normal",edgeRadius:this.edgeRadius||0,strokeStyle:this.strokeStyle||"normal",patternName:this.patternName||"solid",patternSrc:this.patternSrc||null,objClosed:this.objClosed,groupIds:this.groupIds})}),fabric.Ellipse.prototype.toObject=(o=fabric.Ellipse.prototype.toObject,function(e){return fabric.util.object.extend(o.call(this,e),{rx:this.rx,ry:this.ry})}),fabric.Object.customProperties=["id","name"],fabric.generateId=function(e="obj"){return e+"_"+Math.random().toString(36).substr(2,9)};let r=fabric.Object.prototype.initialize;fabric.Object.prototype.initialize=function(...e){return this.id=this.id||fabric.generateId(this.type||"obj"),r.apply(this,e)},fabric.Object.prototype.selectionBackgroundColor="transparent",e.MyCanvas=function(e,t){this.settings=Object.assign({},{selection:!0,selectionColor:"",selectionBorderColor:"",selectionLineWidth:0,preserveObjectStacking:!0,enableAutoSave:!0,enableGride:!0,canvasWidth:"100%",canvasHeight:"100%",gridSize:20,gridColor:"#dee2e6",canvasBackground:"#ffffff",useWindowSize:!1,selectionBackgroundColor:"rgba(255, 0, 0, 0.5)",backgroundColor:"#ff0000",storage_key:"myCanvas"},t),this.elements=a.querySelectorAll(e),this.canvases=[],this.objectArray=[],this.objects={},this.state=[],this.elements.forEach(e=>{e.parentElement;let t=new fabric.Canvas(e);t._toolManager=new ToolManager(t),t.on("mouse:down",e=>{t._toolManager.dispatch("onMouseDown",e)}),t.on("mouse:move",e=>t._toolManager.dispatch("onMouseMove",e)),t.on("mouse:up",e=>t._toolManager.dispatch("onMouseUp",e)),this.setGridBackground(t),t.renderAll(),this.canvases.push({element:e,canvas:t}),this.init(t)})}})(window,document),window.addEventListener("load",()=>{let e=new MyCanvas("#myCanvas",{canvasWidth:"100%",canvasHeight:"100%",selection:!1});window.addEventListener("resize",()=>e.resizeAll())}),MyCanvas.prototype.init=function(){this.canvases.forEach(({})=>{this.addEllipse(),this.addSquare(),this.addDiamond(),this.addEraser(),this.addImg(),this.freeHand(),this.addText(),this.textTools(),this.groupSelected(),this.ungroupSelected(),this.activeOption(),this.strokeColor(),this.strokeWidth(),this.backGroundColor(),this.resizeAll(),this.addPattern(),this.duplicate(),this.strokeStyle(),this.edgeStyle(),this.opacity(),this.layers(),this.addEraser(),this.layoutHandle(),this.keyboardHandle(),this.zoomInOut(),this.undoRedo(),this.enableAutoSave(),this.loadFromLocal(),this.getToLocal(),this.saveToLocal(),this.exportJson(),this.importJson()})},MyCanvas.prototype.addImg=function(){this.canvases.forEach(({canvas:o})=>{let t=document.getElementById("imageFile");var e=document.getElementById("image-click");t?e?(e.addEventListener("click",()=>{var e=document.querySelector(".optionmenu");e&&e.classList.add("show"),t.click()}),t.addEventListener("change",e=>{var t,a=e.target.files[0];a&&((t=new FileReader).onload=e=>{fabric.Image.fromURL(e.target.result,e=>{var t=o.width/2,t=Math.min(t/e.width,o.height/2/e.height,1);e.scale(t),o.centerObject(e),e.set({selectable:!0,hasControls:!0}),e.name="image",o.add(e),o.setActiveObject(e),o.requestRenderAll(),"function"==typeof this.saveToLocal&&this.saveToLocal()})},t.readAsDataURL(a),e.target.value="")})):console.error("Add Image button not found!"):console.error("Image input element not found!")})},MyCanvas.prototype.addEllipse=function(){this.canvases.forEach(({canvas:e})=>{var t=document.getElementById("ellipse-click");let a=e._toolManager;e=createEllipseTool(e,a,this);a.register("ellipse",e),t.addEventListener("click",()=>{a.setActive("ellipse")})})},MyCanvas.prototype.addSquare=function(){this.canvases.forEach(({canvas:e})=>{var t=document.getElementById("square-click");let a=e._toolManager;e=createSquareTool(e,a,this);a.register("square",e),t.addEventListener("click",()=>{a.setActive("square")})})},MyCanvas.prototype.addDiamond=function(){this.canvases.forEach(({canvas:e})=>{var t=document.getElementById("diamond-click");let a=e._toolManager;e=createDiamondTool(e,a,this);a.register("diamond",e),t.addEventListener("click",()=>{a.setActive("diamond")})})},MyCanvas.prototype.freeHand=function(){this.canvases.forEach(({canvas:e})=>{var t=document.getElementById("pencil-click");let a=e._toolManager;e=createFreeHandTool(e);a.register("freeHand",e),t.addEventListener("click",()=>{a.setActive("freeHand")})})},fabric.Textbox.prototype.fontFamily="Roboto",fabric.Textbox.prototype.lockUniScaling=!0,(()=>{let t=fabric.Textbox.prototype.toObject;fabric.Textbox.prototype.toObject=function(e){return fabric.util.object.extend(t.call(this,e),{text:this.text||"",fontFamily:this.fontFamily||"Roboto",fontSize:this.fontSize,textAlign:this.textAlign||"left"})}})(),fabric.Textbox.fromObject=function(e,t){e.text=e.text||"",t(new fabric.Textbox(e.text,e))},MyCanvas.prototype.addText=function(){this.canvases.forEach(({canvas:t})=>{var e=document.getElementById("text-click");let a=this;e&&e.addEventListener("click",()=>{var e=new fabric.Textbox("Type here",{left:500,top:200,fontSize:22,fontFamily:"Roboto",fill:"#000",editable:!0});e.name="textbox",e.setControlsVisibility({mt:!1,mb:!1,ml:!1,mr:!1}),t.add(e),t.setActiveObject(e),t.requestRenderAll(),a.saveToLocal()})})},MyCanvas.prototype.textTools=function(){this.canvases.forEach(({canvas:a})=>{let o=this,e=document.getElementById("text-color"),t=document.getElementById("font-family-select");var r=document.querySelectorAll(".font-size-click");let n=document.querySelectorAll(".text-align-click"),s=null;a.on("selection:created",e=>{s=e.selected?.[0]||null}),a.on("selection:updated",e=>{s=e.selected?.[0]||null}),a.on("selection:cleared",()=>{s=null}),a.on("object:scaling",e=>{var t,e=e.target;e&&"textbox"===e.type&&(t=(e.scaleX+e.scaleY)/2,e.set({fontSize:e.fontSize*t,scaleX:1,scaleY:1}),e.initDimensions(),e.setCoords(),o.saveToLocal(),a.requestRenderAll())}),e&&e.addEventListener("input",()=>{s&&"textbox"===s.type&&(s.set({fill:e.value,opacity:1}),o.saveToLocal(),a.requestRenderAll())}),t&&t.addEventListener("change",()=>{if(s&&"textbox"===s.type){let e=t.value;loadFontSafe(e).then(()=>{s.set("fontFamily",e),s.initDimensions(),s.setCoords(),o.saveToLocal(),a.requestRenderAll()})}}),r.forEach(t=>{t.addEventListener("click",()=>{var e;s&&"textbox"===s.type&&(e=parseInt(t.dataset.fontSize),s.set("fontSize",e),o.saveToLocal(),a.requestRenderAll())})}),n.forEach(t=>{t.addEventListener("click",()=>{var e;s&&"textbox"===s.type&&(e=t.dataset.textAlign,s.set("textAlign",e),a.fire("object:modified",{target:s}),o.saveToLocal(),a.requestRenderAll(),n.forEach(e=>e.classList.remove("active")),t.classList.add("active"))})})})},MyCanvas.prototype.addEraser=function(){this.canvases.forEach(({canvas:t})=>{let e=document.getElementById("eraser-click");if(!e)return void console.warn("addEraser: #eraser button not found");let a=this;if(e._eraseInited)return;e._eraseInited=!0;let o=()=>{a._eraseMode&&(a._eraseMode=!1,e.classList.remove("active"),t.selection=!0,a._eraseHandler&&(t.off("mouse:down",a._eraseHandler),delete a._eraseHandler),a._eraseKeyHandler&&(document.removeEventListener("keydown",a._eraseKeyHandler),delete a._eraseKeyHandler),t.requestRenderAll())};e.addEventListener("click",()=>{a._eraseMode?o():a._eraseMode||(a._eraseMode=!0,e.classList.add("active"),t.selection=!1,a._eraseHandler=function(e){e=e.target||e.e&&t.findTarget(e.e,!0);if(e)if("activeSelection"===e.type||"group"===e.type?(e._objects||[]).slice().forEach(e=>t.remove(e)):t.remove(e),t.discardActiveObject(),t.requestRenderAll(),"function"==typeof a.saveToLocal)try{a.saveToLocal()}catch(e){console.error("saveToLocal threw:",e)}else try{localStorage.setItem("myCanvas",JSON.stringify(t.toJSON())),console.log("LocalStorage fallback saved")}catch(e){console.error("localStorage save failed:",e)}},t.on("mouse:down",a._eraseHandler),a._eraseKeyHandler=function(e){"Escape"===e.key&&o()},document.addEventListener("keydown",a._eraseKeyHandler))})})},MyCanvas.prototype.zoomInOut=function(){this.canvases.forEach(({canvas:a})=>{function o(){document.querySelector(".zoom-count").innerText=Math.round(100*a.getZoom())+"%"}document.querySelector(".zoom-plus").onclick=function(){let e=a.getZoom();e+=.1,5<(e=Math.round(10*e)/10)&&(e=5);var t=new fabric.Point(a.getWidth()/2,a.getHeight()/2);a.zoomToPoint(t,e),o()},document.querySelector(".zoom-minus").onclick=function(){let e=a.getZoom();e-=.1,(e=Math.round(10*e)/10)<.1&&(e=.1);var t=new fabric.Point(a.getWidth()/2,a.getHeight()/2);a.zoomToPoint(t,e),o()},a.setViewportTransform([1,0,0,1,0,0]),o(),a.requestRenderAll();let r=!1,n=0,s=0;a.on("mouse:down",function(e){e.e.altKey&&(r=!0,a.selection=!1,n=e.e.clientX,s=e.e.clientY)}),a.on("mouse:move",function(e){var t;r&&(e=e.e,(t=a.viewportTransform)[4]+=e.clientX-n,t[5]+=e.clientY-s,a.requestRenderAll(),n=e.clientX,s=e.clientY)}),a.on("mouse:up",function(){r=!1,a.selection=!0})})},MyCanvas.prototype.undoRedo=function(){this.canvases.forEach(({canvas:t})=>{let a=this;document.querySelector(".undo").onclick=()=>t.undo(),document.querySelector(".redo").onclick=()=>t.redo(),t._undoStack=[],t._redoStack=[],t._isRestoring=!1;function e(){var e;t._isRestoring||(e=JSON.stringify(t.toJSON(["startHeadType","endHeadType","isArrow","arrowPoints"])),t._undoStack.push(e),100<t._undoStack.length&&t._undoStack.shift(),t._redoStack.length=0)}t.on("object:added",e),t.on("object:modified",e),t.on("object:removed",e),t.on("path:created",e),e(),t.undo=function(){var e;t._undoStack.length<=1||(e=t._undoStack.pop(),t._redoStack.push(e),100<t._redoStack.length&&t._redoStack.shift(),e=t._undoStack[t._undoStack.length-1],t._isRestoring=!0,t.loadFromJSON(e,function(){t.renderAll(),t._isRestoring=!1}),a.setGridBackground(t))},t.redo=function(){var e;0!==t._redoStack.length&&(e=t._redoStack.pop(),t._undoStack.push(e),100<t._undoStack.length&&t._undoStack.shift(),t._isRestoring=!0,t.loadFromJSON(e,function(){t.renderAll(),t._isRestoring=!1}),a.setGridBackground(t))}})},MyCanvas.prototype.groupSelected=function(){var e=document.querySelector(".group-btn");e&&e.addEventListener("click",()=>{this.canvases.forEach(({canvas:e})=>{var t=e.getActiveObject();t&&"activeSelection"===t.type&&(t=t.toGroup(),e.setActiveObject(t),e.requestRenderAll(),e.saveState)&&e.saveState()})})},MyCanvas.prototype.ungroupSelected=function(){var e=document.querySelector(".ungroup-btn");e&&e.addEventListener("click",()=>{this.canvases.forEach(({canvas:e})=>{var t=e.getActiveObject();t&&"group"===t.type&&(t=t.toActiveSelection(),e.setActiveObject(t),e.requestRenderAll(),e.saveState)&&e.saveState()})})},MyCanvas.prototype.setGridBackground=function(e){var t=this.settings.gridSize,a=document.createElement("canvas"),o=(a.width=t,a.height=t,a.getContext("2d")),t=(o.fillStyle=this.settings.canvasBackground,o.fillRect(0,0,e.width,e.height),o.strokeStyle=this.settings.gridColor,o.beginPath(),o.moveTo(t,0),o.lineTo(t,t),o.moveTo(0,t),o.lineTo(t,t),o.stroke(),new fabric.Pattern({source:a,repeat:"repeat"}));e.setBackgroundColor(t,e.renderAll.bind(e))},MyCanvas.prototype.resizeAll=function(){this.canvases.forEach(({canvas:e})=>{var t=document.querySelector("body"),a=t.offsetWidth,t=t.offsetHeight;e.setWidth(a),e.setHeight(t),this.setGridBackground(e),e.renderAll()})},MyCanvas.prototype.strokeColor=function(){let r=this;this.canvases.forEach(({canvas:a})=>{var e=document.querySelectorAll(".stroke-color-click");e.forEach(e=>{var t=e.getAttribute("data-stroke-color");e.style.backgroundColor=t});let o=null;a.on("selection:created",e=>{e.selected&&0<e.selected.length&&(o=e.selected[0])}),a.on("selection:updated",e=>{e.selected&&0<e.selected.length&&(o=e.selected[0])}),a.on("selection:cleared",()=>{o=null}),e.forEach(t=>{t.addEventListener("click",()=>{var e;o?(e=t.getAttribute("data-stroke-color"),o.set("stroke",e),a.renderAll(),r.saveToLocal()):console.log("âš ï¸ No object selected")})})})},MyCanvas.prototype.strokeWidth=function(){this.canvases.forEach(({canvas:a})=>{var e=document.querySelectorAll(".stroke-click");let o=null;a.on("selection:created",e=>{e.selected&&0<e.selected.length&&(o=e.selected[0])}),a.on("selection:updated",e=>{e.selected&&0<e.selected.length&&(o=e.selected[0])}),a.on("selection:cleared",()=>{o=null}),e.forEach(t=>{t.addEventListener("click",()=>{var e;o?(e=t.getAttribute("data-stroke-width"),console.log("getStrokeWidth:",typeof e),e=parseInt(e,10),e=void 0!==self.currentOption?.strokeWidth?self.currentOption.strokeWidth:e,o.set("strokeWidth",e),a.renderAll(),this.saveToLocal()):console.log("âš ï¸ No object selected")})})})},MyCanvas.prototype.backGroundColor=function(){this.canvases.forEach(({canvas:a})=>{let o=document.querySelectorAll(".background-click"),r=(o.forEach(e=>{e.style.backgroundColor=e.dataset.bgColor}),null);a.on("selection:created",e=>{e.selected&&0<e.selected.length&&(r=e.selected[0])}),a.on("selection:updated",e=>{e.selected&&0<e.selected.length&&(r=e.selected[0])}),a.on("selection:cleared",()=>{r=null}),o.forEach(t=>{t.addEventListener("click",()=>{var e;r?(o.forEach(e=>e.classList.remove("active")),t.classList.add("active"),e=t.dataset.bgColor,"freeHand"!==r.name||!0===r.objClosed?r.set("fill",e):r.set("fill",null),a.renderAll(),this.saveToLocal()):console.log("âš ï¸ No object selected")})})})},MyCanvas.prototype.addPattern=function(){this.canvases.forEach(({canvas:n})=>{var e=document.querySelectorAll(".pattern-click");let s=null;n.on("selection:created",e=>{s=e.selected?.[0]||null,console.log(s)}),n.on("selection:updated",e=>{s=e.selected?.[0]||null}),n.on("selection:cleared",()=>{s=null}),e.forEach(r=>{r.addEventListener("click",()=>{var e,t,a,o;s?(e=r.dataset.pattern,a=(JSON.parse(localStorage.getItem("currentOption"))||{}).bgColor||"#ffc9c9","solid"===e?("freeHand"!==s.name||!0===s.objClosed?s.set({fill:a,baseColor:a,patternSrc:null,patternName:"solid"}):s.set({fill:null,baseColor:null,patternSrc:null,patternName:"solid"}),n.renderAll(),this.saveToLocal()):"hachure"===e||"cross-hatch"===e?((t=document.createElement("canvas")).width=10,t.height=10,(o=t.getContext("2d")).strokeStyle=a,o.lineWidth=1,"hachure"===e?(o.beginPath(),o.moveTo(0,0),o.lineTo(10,10)):(o.beginPath(),o.moveTo(0,0),o.lineTo(10,10),o.stroke(),o.beginPath(),o.moveTo(10,0),o.lineTo(0,10)),o.stroke(),a=new fabric.Pattern({source:t,repeat:"repeat"}),o=t.toDataURL("image/png"),"freeHand"!==s.name||!0===s.objClosed?s.set({fill:a,patternName:e,patternSrc:o}):s.set({fill:null,patternName:null,patternSrc:null}),n.renderAll(),this.saveToLocal()):fabric.loadSVGFromURL(e,(e,t)=>{var e=fabric.util.groupSVGElements(e,t),t=(console.log("svgGroup",e),30/e.width),a=30/e.height,t=(e.scaleX=t,e.scaleY=a,new fabric.StaticCanvas(null,{width:30,height:30})),a=(t.add(e),t.renderAll(),new fabric.Pattern({source:t.getElement(),repeat:"repeat"}));s.set({fill:a}),n.renderAll(),this.saveToLocal()})):console.warn("âš ï¸ No object selected")})})})},MyCanvas.prototype.keyboardHandle=function(){this.canvases.forEach(({canvas:t})=>{var e=document.querySelector(".delete-obj");let a=this;e.addEventListener("click",function(){var e=t.getActiveObject();e&&(t.remove(e),t.discardActiveObject(),t.requestRenderAll(),a.saveToLocal())})}),this._keyboardListenerAdded||(document.addEventListener("keydown",e=>{"Delete"!==e.key&&"Backspace"!==e.key||this.canvases.forEach(({canvas:e})=>{var t=e.getActiveObject();t&&(e.remove(t),e.discardActiveObject(),e.requestRenderAll(),(t=document.querySelector(".optionmenu"))&&t.classList.remove("show"),this.saveToLocal())})}),this._keyboardListenerAdded=!0)},MyCanvas.prototype.duplicate=function(){let o=this;this.canvases.forEach(({canvas:a})=>{document.querySelector(".duplicate-obj").addEventListener("click",function(){let t=a.getActiveObject();t&&t.clone(function(e){e.set({left:t.left+10,top:t.top+10}),a.add(e),a.setActiveObject(e),a.requestRenderAll(),o.saveToLocal()})})})},MyCanvas.prototype.strokeStyle=function(){this.canvases.forEach(({canvas:t})=>{var e=document.querySelectorAll(".stroke-style-click");let a=null;t.on("selection:created",e=>{e.selected&&0<e.selected.length&&(a=e.selected[0])}),t.on("selection:updated",e=>{e.selected&&0<e.selected.length&&(a=e.selected[0])}),t.on("selection:cleared",()=>{a=null}),e.forEach(e=>{e.addEventListener("click",()=>{if(a){switch(e.getAttribute("data-stroke-style")){case"dash":a.set({strokeDashArray:[10,5],strokeStyle:"dash"});break;case"dot":a.set({strokeDashArray:[2,4],strokeStyle:"dot"});break;default:a.set({strokeDashArray:[],strokeStyle:"normal"})}t.renderAll(),this.saveToLocal()}else console.log("âš ï¸ No object selected")})})})},(()=>{let t=fabric.Rect.prototype.toObject;fabric.Rect.prototype.toObject=function(e){return fabric.util.object.extend(t.call(this,e),{rx:this.rx||0,ry:this.ry||0})}})(),(()=>{let t=fabric.Image.prototype.toObject;fabric.Image.prototype.toObject=function(e=[]){return fabric.util.object.extend(t.call(this,[...e]),{clipPath:this.clipPath?this.clipPath.toObject():null})}})(),fabric.Path.fromObject=function(e,t){e.path?t(new fabric.Path(e.path,e)):t(null)},fabric.Image.fromObject=function(a,o){fabric.util.loadImage(a.src,function(e){let t=new fabric.Image(e,a);a.clipPath?fabric.util.enlivenObjects([a.clipPath],function([e]){e.absolutePositioned=!1,t.clipPath=e,o(t)}):o(t)})},MyCanvas.prototype.edgeStyle=function(){this.canvases.forEach(({canvas:c})=>{var e=document.querySelectorAll(".edge-click");let h=null;c.on("selection:created",e=>{h=e.selected?.[0]||null}),c.on("selection:updated",e=>{h=e.selected?.[0]||null}),c.on("selection:cleared",()=>{h=null}),e.forEach(e=>{e.addEventListener("click",()=>{if(h){var n=e.getAttribute("data-edge"),s=parseFloat(e.getAttribute("data-radius"))||0;if("rect"===h.type)h.set({rx:"round"===n?s:0,ry:"round"===n?s:0}),c.renderAll(),this.saveToLocal();else if("image"===h.type)l=h,"round"===n&&(l.clipPath?l.clipPath.set({rx:s,ry:s}):l.clipPath=new fabric.Rect({width:l.width,height:l.height,rx:s,ry:s,originX:"center",originY:"center"}),console.log("ROUND",l.clipPath),l.edgeStyle="round",l.edgeRadius=s),"sharp"!==n&&"normal"!==n||(l.set({clipPath:null}),l.edgeStyle=n,l.edgeRadius=0),l.setCoords(),c.renderAll(),this.saveToLocal();else if("line"===h.type||"path"===h.type){h.set("strokeDashArray",null);let t,a,o,r;if("line"===h.type)({x1:t,y1:a,x2:o,y2:r}=h);else{var l=h.path;if(!l||l.length<2)return;[_,t,a]=l[0];var l=l[l.length-1];o=l[l.length-2],r=l[l.length-1]}if("normal"===n)l=new fabric.Line([t,a,o,r],{stroke:h.stroke,strokeWidth:h.strokeWidth,selectable:!0}),c.remove(h),c.add(l),h=l;else{var l=(t+o)/2,i=(a+r)/2;let e;"round"===n&&(e=`M ${t} ${a} Q ${l} ${i-s} ${o} `+r),"sharp"===n&&(e=`M ${t} ${a} L ${l} ${i-(s||80)} L ${o} `+r);n=new fabric.Path(e,{stroke:h.stroke,strokeWidth:h.strokeWidth,fill:"",selectable:!0,objectCaching:!1});c.remove(h),c.add(n),h=n}c.renderAll(),this.saveToLocal()}}else console.warn("âš ï¸ No object selected")})})})},MyCanvas.prototype.opacity=function(){this.canvases.forEach(({canvas:t})=>{let a=document.querySelector(".opacity-input"),o=null;t.on("selection:created",e=>{e.selected&&0<e.selected.length&&(o=e.selected[0],a)&&(a.value=Math.round(100*(o.opacity??1)))}),t.on("selection:updated",e=>{e.selected&&0<e.selected.length&&(o=e.selected[0],a)&&(a.value=Math.round(100*(o.opacity??1)))}),t.on("selection:cleared",()=>{o=null,a&&(a.value=100)}),a&&a.addEventListener("input",e=>{o&&(e=parseFloat(e.target.value),o.set("opacity",e/100),t.renderAll(),this.saveToLocal())})})},MyCanvas.prototype.layers=function(){this.canvases.forEach(({canvas:t})=>{function e(){var e=t.getActiveObject();return e?"activeSelection"===e.type?e._objects||[]:[e]:(alert("Select an object first"),[])}t.preserveObjectStacking=!0,document.getElementById("bringToFront").onclick=()=>{e().forEach(e=>e.bringToFront()),t.requestRenderAll(),this.saveToLocal()},document.getElementById("sendToBack").onclick=()=>{e().forEach(e=>e.sendToBack()),t.requestRenderAll(),this.saveToLocal()},document.getElementById("bringForward").onclick=()=>{e().forEach(e=>e.bringForward()),t.requestRenderAll(),this.saveToLocal()},document.getElementById("sendBackward").onclick=()=>{e().forEach(e=>e.sendBackwards()),t.requestRenderAll(),this.saveToLocal()}})},MyCanvas.prototype.initOptionMenu=function(){this.groups={strokeColor:document.getElementById("stroke-color-group"),background:document.getElementById("background-group"),color:document.getElementById("color-group"),strokeWidth:document.getElementById("stroke-group"),strokeStyle:document.getElementById("stroke-style"),pattern:document.getElementById("pattern-group"),lineType:document.getElementById("line-type-group"),arrowType:document.getElementById("arrow-type-group"),arrowHead:document.getElementById("arrow-head-group"),freeHand:document.getElementById("free-hand-group"),fontFamily:document.getElementById("font-family-group"),fontSize:document.getElementById("font-size-group"),textAlign:document.getElementById("text-align-group"),edge:document.getElementById("edge-group"),opacity:document.getElementById("opacity-group"),layers:document.getElementById("layer-group"),action:document.getElementById("action-group")}},MyCanvas.prototype.toolPanels={ellipse:["strokeColor","background","strokeWidth","strokeStyle","pattern","opacity","layers","action"],rect:["strokeColor","background","strokeWidth","strokeStyle","pattern","edge","opacity","layers","action"],diamond:["strokeColor","background","strokeWidth","strokeStyle","pattern","edge","opacity","layers","action"],polygon:["strokeColor","background","strokeWidth","strokeStyle","opacity","layers","action","lineType"],arrow:["strokeColor","strokeWidth","strokeStyle","arrowType","arrowHead","opacity","layers","action"],pencil:["strokeColor","background","pattern","freeHand","strokeWidth","opacity","layers","action"],text:["fontFamily","fontSize","textAlign","opacity","layers","action"],image:["edge","opacity","layers","action"]},MyCanvas.prototype.hideAllGroups=function(){this.groups&&Object.values(this.groups).forEach(e=>{e&&(e.style.display="none")})},MyCanvas.prototype.showGroups=function(...e){this.groups&&e.forEach(e=>{this.groups[e]&&(this.groups[e].style.display="block")})},MyCanvas.prototype.toggleOptionMenu=function(e){var t=document.querySelector(".optionmenu");t&&t.classList.toggle("show",e)},MyCanvas.prototype.showPanelsFor=function(e){e=this.toolPanels[e];e&&(this.hideAllGroups(),this.toggleOptionMenu(!0),this.showGroups(...e))},MyCanvas.prototype.bindTopbar=function(){Object.entries({ellipse:"ellipse-click",rect:"square-click",diamond:"diamond-click",image:"image-click",arrow:"arrows-click",polygon:"line-click",pencil:"pencile-click",text:"text-click",eraser:"eraser-click"}).forEach(([e,t])=>{t=document.getElementById(t);t&&t.addEventListener("click",()=>{this.showPanelsFor(e)})})},MyCanvas.prototype.handleSelection=function(t){t=t.selected&&t.selected[0];if(t){let e=null;t.isArrow||"arrow"===t.name?e="arrow":t.isLineTool||"line-tool"===t.name?e="polygon":t.isPencil||"freeHand"===t.name?e="pencil":"rect"===t.type?e="rect":"diamond"===t.type?e="diamond":"ellipse"===t.type?e="ellipse":"polygon"===t.type?e="polygon":"textbox"===t.type||"i-text"===t.type||"text"===t.type?e="text":"image"===t.type&&(e="image"),e&&this.showPanelsFor(e)}},MyCanvas.prototype.layoutHandle=function(){this.canvases.forEach(({canvas:e})=>{this.initOptionMenu(),this.bindTopbar(),e.on("mouse:down",e=>{e.target||(this.toggleOptionMenu(!1),this.hideAllGroups())}),e.on("selection:created",e=>this.handleSelection(e)),e.on("selection:updated",e=>this.handleSelection(e)),e.on("selection:cleared",()=>{this.toggleOptionMenu(!1),this.hideAllGroups()})})},MyCanvas.prototype.activeOption=function(){this.canvases.forEach(({canvas:n})=>{let s=this;var e=document.querySelectorAll(".optionmenu .menu-group"),t=(this.currentOption={strokeStyle:"normal",strokeColor:"#1e1e1e",strokeWidth:1,pattern:"solid",bgColor:"#ffc9c9",opacity:100,edge:"sharp"},localStorage.getItem("currentOption"));t?this.currentOption=JSON.parse(t):localStorage.setItem("currentOption",JSON.stringify(this.currentOption)),this.getDataAttribute=function(e){return e.dataset.strokeStyle?{key:"strokeStyle",value:e.dataset.strokeStyle}:e.dataset.strokeColor?{key:"strokeColor",value:e.dataset.strokeColor}:e.dataset.strokeWidth?{key:"strokeWidth",value:parseInt(e.dataset.strokeWidth,10)}:e.dataset.bgColor?{key:"bgColor",value:e.dataset.bgColor}:e.dataset.opacity?{key:"opacity",value:e.dataset.opacity}:e.dataset.pattern?{key:"pattern",value:e.dataset.pattern}:e.dataset.edge?{key:"edge",value:e.dataset.edge}:null},this.getStrokeDashArray=e=>"dash"===e?[10,5]:"dot"===e?[2,2]:[],this.reverseStrokeDashArray=e=>Array.isArray(e)&&e.length?"10,5"===e.join(",")?"dash":"2,2"===e.join(",")?"dot":"normal":"normal",this.rgbToHex=function(e){return e&&"string"==typeof e?"#"===e[0]?e:(e=e.match(/\d+/g))?"#"+e.slice(0,3).map(e=>parseInt(e).toString(16).padStart(2,"0")).join(""):"":""},this.updateOptionMenuFromOption=function(a){document.querySelectorAll(".optionmenu .menu-icon").forEach(e=>{var t=s.getDataAttribute(e);e.classList.toggle("active",t&&a[t.key]===t.value)})},e.forEach(e=>{e.querySelectorAll(".menu-icon").forEach(r=>{r.addEventListener("click",()=>{var e=s.getDataAttribute(r);if(e){var{key:e,value:t}=e,a=(s.currentOption[e]=t,n.getActiveObject());if(a){switch(e){case"strokeColor":a.set("stroke",t);break;case"strokeWidth":a.set("strokeWidth",parseInt(t));break;case"opacity":a.set("opacity",parseFloat(t)/100);break;case"strokeStyle":s.currentOption.strokeStyle=t,a.set({strokeDashArray:s.getStrokeDashArray(t),strokeWidth:a.strokeWidth||1,stroke:a.stroke||"#000"});break;case"edge":var o=r.dataset.radius?parseInt(r.dataset.radius):0;"rect"===a.type&&a.set({rx:o,ry:o}),"image"===a.type&&a.set({rx:o,ry:o});break;case"bgColor":s.currentOption.bgColor=t,a.set({fill:t});break;case"pattern":s.currentOption.pattern=t,a.set({pattern:t})}a.dirty=!0,a.setCoords(),n.requestRenderAll(),localStorage.setItem("myCanvas",JSON.stringify(n.getObjects().map(e=>e.toObject()))),localStorage.setItem("currentOption",JSON.stringify(s.currentOption))}}})})});let a=e=>{s.currentOption={strokeColor:e.stroke||"#000",strokeWidth:e.strokeWidth||1,bgColor:e.patternName&&"solid"!==e.patternName?e.baseColor||s.currentOption.bgColor:s.rgbToHex(e.fill)||"#fff",opacity:e.opacity?100*e.opacity:100,strokeStyle:e.strokeStyle,edge:e.rx&&0<e.rx?"round":"sharp",pattern:e.patternName||"solid"},s.updateOptionMenuFromOption(s.currentOption),localStorage.setItem("currentOption",JSON.stringify(s.currentOption))};n.on("selection:created",e=>a(e.selected[0])),n.on("selection:updated",e=>a(e.selected[0])),n.requestRenderAll(),this.updateOptionMenuFromOption(this.currentOption)})},MyCanvas.prototype.activeMainMenu=function(){this.canvases.forEach(({canvas:e})=>{let a=document.querySelectorAll(".topbar .menu-icon"),t=localStorage.getItem("mainmenu"),o=(t&&a.forEach(e=>e.classList.toggle("active",e.getAttribute("data-menu")===t)),a.forEach(e=>{e.addEventListener("click",e=>{e.stopPropagation(),a.forEach(e=>e.classList.remove("active"));var t=e.currentTarget.getAttribute("data-menu");e.currentTarget.classList.add("active"),localStorage.setItem("mainmenu",t)})}),{ellipse:"data-menu-circle",circle:"data-menu-circle",rect:"data-menu-square",path:"data-menu-diamond",image:"data-menu-image",line:"data-menu-polyline",textbox:"data-menu-text",text:"data-menu-text",pencil:"data-menu-pencile",erase:"data-menu-erase",arrow:"data-menu-arrow"});function r(e){var e=e.selected[0];if(e){let t=null;t="arrow"===e.name?"data-menu-arrow":(e=e.type,o[e]),console.log("Final Menu Key:",t),t&&(a.forEach(e=>e.classList.remove("active")),e=[...a].find(e=>e.getAttribute("data-menu")===t),console.log("Target menu:",e),e)&&(e.classList.add("active"),localStorage.setItem("mainmenu",t))}}e.on("selection:created",r),e.on("selection:updated",r)})},MyCanvas.prototype.loadFromLocal=function(){this.canvases.forEach(({canvas:a})=>{let t=this,e=this.getToLocal();var o;e&&e.length&&(o=[...new Set(e.filter(e=>"textbox"===e.type).map(e=>e.fontFamily||"Roboto"))],Promise.all(o.map(loadFontSafe)).then(()=>{fabric.util.enlivenObjects(e,e=>{a.clear(),e.forEach(t=>{"textbox"===t.type&&(t.set("fontFamily",t.fontFamily||"Roboto"),t.initDimensions(),t.setCoords()),a.add(t),t.patternSrc&&fabric.Image.fromURL(t.patternSrc,e=>{e&&e.getElement&&(e=new fabric.Pattern({source:e.getElement(),repeat:"repeat"}),t.set("fill",e),t.dirty=!0,a.requestRenderAll())},{crossOrigin:"anonymous"})}),t.setGridBackground(a),a.requestRenderAll()})}))})},MyCanvas.prototype.getToLocal=function(){var e=localStorage.getItem("myCanvas");return e?JSON.parse(e):[]},MyCanvas.prototype.saveToLocal=function(){this.canvases.forEach(({canvas:e})=>{e=e.getObjects().map(e=>e.toObject(["id"]));localStorage.setItem("myCanvas",JSON.stringify(e))})},MyCanvas.prototype.enableAutoSave=function(){this.canvases.forEach(({canvas:e})=>{var t=()=>{e._isRestoring||this.saveToLocal()};e.on("object:added",t),e.on("object:modified",t),e.on("object:removed",t),e.on("path:created",t)})},MyCanvas.prototype.exportJson=function(){this.canvases.forEach(({canvas:a})=>{document.querySelectorAll(".export-click").forEach(e=>{e.addEventListener("click",()=>{var e=a.toJSON(["edgeStyle","edgeRadius","patternSrc","fillMode"]),e=JSON.stringify(e,null,2),e=new Blob([e],{type:"application/json"}),e=URL.createObjectURL(e),t=document.createElement("a");t.href=e,t.download="canvas.json",t.click(),URL.revokeObjectURL(e)})})})},MyCanvas.prototype.importJson=function(){var e=document.getElementById("jsonUpload");e&&"true"!==e.dataset.bound&&(e.dataset.bound="true",e.addEventListener("change",t=>{var a=t.target.files[0];if(a){let e=new FileReader;e.onload=()=>{let t;try{t=JSON.parse(e.result)}catch(e){return void console.error("Invalid JSON file")}this.canvases.forEach(({canvas:e})=>{e.clear(),e.loadFromJSON(t,()=>{e.renderAll()},(e,t)=>{t.edgeStyle=t.edgeStyle||"normal",t.edgeRadius=t.edgeRadius||0,t.patternSrc=t.patternSrc||null,t.fillMode=t.fillMode||"solid"})})},e.readAsText(a),t.target.value=""}}))};